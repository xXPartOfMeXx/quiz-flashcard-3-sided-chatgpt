<!DOCTYPE html>
<html lang="en">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=0.8">
  <meta charset="UTF-8">
  <title>√îN T·∫¨P FLASHCARD 3 M·∫∂T (T·ª∞ LU·∫¨N)</title>
  <style>
  /* Make labels and input boxes match MCQ site */
  label {
    font-size: 1.0rem;
    font-weight: 600;
  }
  input[type="number"],
  input[type="file"],
  input.answer-input {
    font-size: 1.0rem;
    padding: 4px 6px;
    margin-top: 5px;
    border-radius: 6px;
    border: 1px solid #ccc;
  }
  #replayLimit,
  #replayTime {
    font-size: 1.0rem;
    padding: 4px 6px;
    border-radius: 6px;
    border: 1px solid #ccc;
    text-align: center;
  }

  #confirmReplay:hover { background-color: #0056b3 !important; }
  #cancelReplay:hover { background-color: #b02a37 !important; }
    /* Reuse styles from the MCQ version */
    body { font-family: Arial, sans-serif; margin: 30px; background: #f9f9f9; }
    h2 { margin-top: 20px; }
    .subtitle { font-size: 0.9rem; color: #555; font-style: italic; margin-bottom: 15px; margin-left: 20px; }
    .rednotething { margin-left: 20px; font-size:0.9rem; font-style:italic; font-weight:bold; color:#FF0000; }
    .rednotethingbig { margin-left: 20px; font-size:1.2rem; font-style:italic; font-weight:bold; color:#FF0000; }
    .question-box { background: #fff; padding: 20px; margin-bottom: 15px; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    input.answer-input {
      display: block;
      width: 97%; //vl anh jack
      font-size: 1.4rem;
      padding: 10px;
      margin-top: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }
    button.submit-btn {
      display: block;
      margin-top: 8px;
      padding: 10px 20px;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
    }
    button.submit-btn:hover { background-color: #0056b3; }
    .feedback { margin-top: 10px; font-weight: bold; white-space: pre-line; }
    #scoreBox { margin-top: 30px; padding: 15px; background: #fff; border-radius: 8px; font-size: 1.2em; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    #timerDisplay {
      position: fixed; top: 20px; right: 30px;
      background-color: #fff3cd; border: 2px solid #ffc107; color: #d9534f;
      padding: 10px 15px; border-radius: 10px; font-weight: bold; font-size: 2rem;
      box-shadow: 0 2px 6px rgba(0,0,0,0.2); z-index: 1000;
    }
    .replay-btn {
      position: fixed; bottom: 20px; right: 20px;
      width: 100px; height: 100px; font-size: 4rem;
      border: none; background: none; color: white; cursor: pointer;
      z-index: 1000; opacity: 0.9; transition: all 0.2s ease;
    }
    .replay-btn:hover { transform: scale(1.1); }
  </style>
</head>
<body>

<button id="resetBtn" title="Reset (B·∫°n ph·∫£i upload l·∫°i file!)" style="display:none; position:fixed; font-size:3.5rem; background:none; border:none; color:#007bff; cursor:pointer; z-index:1000; opacity:0.9; top:20px; left:48%">üîÑ</button>

<button onclick="window.open('https://github.com/xXPartOfMeXx/quiz-flashcard-3-sided-chatgpt/tree/main', '_blank')" 
        style="padding:10px 20px; margin:5px; font-size:1rem; font-weight:bold; border:none; border-radius:6px; background-color:#28a745; color:white; cursor:pointer;">
  üíª GitHub Page of this site
</button>

<h1 id="mainTitle" style="text-align:center;">√îN T·∫¨P FLASHCARD 3 M·∫∂T (T·ª∞ LU·∫¨N)</h1>

<div id="setupSection">
<p class="subtitle">
    Ch·ªçn s·ªë c√¢u h·ªèi v√† th·ªùi gian l√†m b√†i r·ªìi t·∫£i l√™n file [*.csv] ƒë·ªÉ b·∫Øt ƒë·∫ßu.
  </p>
  <p class="rednotething">
    *FORMAT B·∫ÆT BU·ªòC: [ƒê·ªÅ,C√¢u tr·∫£ l·ªùi,L√Ω gi·∫£i] t∆∞∆°ng ·ª©ng v·ªõi [Face1,Face2,Face3]<br><br>
    Xem l·∫°i v√† ch·ªânh s·ª≠a flashcard 3 m·∫∑t 
    <a href="https://xxpartofmexx.github.io/3faceflashcard-creator/" target="_blank">t·∫°i ƒë√¢y</a>.
    (h·ªó tr·ª£ ƒëi·ªán tho·∫°i nh∆∞ng x·∫•u...)
  </p>
  <label style="margin-left:20px;" for="limitInput">S·ªë c√¢u h·ªèi:</label>
  <input type="number" id="limitInput" min="1" style="width:70px"><br>
  <label style="margin-left:20px;" for="timeInput">Th·ªùi gian l√†m b√†i (ph√∫t):</label>
  <input type="number" id="timeInput" min="0.1" step="0.1" style="width:80px"><br>

  <p style="font-size:1.2rem; margin-left:20px;">T·∫£i l√™n file [*.csv]:
    <label for="csvFile" style="display:inline-block; background-color:#007bff; color:white; padding:10px 20px; border-radius:6px; cursor:pointer; font-weight:bold;">üìÇ</label>
    <input type="file" id="csvFile" accept=".csv" style="display:none;">
  </p>

  <p id="importStatus" style="margin-left:20px; font-weight:bold; color:green; font-size:1.1rem;"></p>
  <div style="margin-left:20px; margin-top:10px;">
    <button id="startBtn" style="display:none; padding:10px 20px; font-size:1rem; font-weight:bold; border:none; border-radius:6px; background-color:#007bff; color:white; cursor:pointer;">‚ñ∂Ô∏è Start Quiz</button>
  </div>
</div>

<div id="quiz"></div>
<div id="scoreBox"></div>
<h2 id="timerDisplay" style="display:none;">‚è±Ô∏è 00:00</h2>
<button id="replayBtn" class="replay-btn" style="display:none;" title="Ch∆°i l·∫°i">üîÅ</button>

<script>
let timerInterval, quizEnded = false, remainingSeconds = 0, quizStartTime;
let correctCountGlobal = 0, totalQuestionsGlobal = 0;
let lastCSVData = null;
let fileNameGlobal = "";

function parseCSV(text) {
  const rows = [];
  let insideQuotes = false, field = "", row = [];
  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    if (c === '"') insideQuotes = !insideQuotes;
    else if (c === ',' && !insideQuotes) { row.push(field); field = ""; }
    else if ((c === '\n' || c === '\r') && !insideQuotes) {
      if (field || row.length) { row.push(field); rows.push(row); row = []; field = ""; }
      if (c === '\r' && text[i + 1] === '\n') i++;
    } else field += c;
  }
  if (field || row.length) { row.push(field); rows.push(row); }
  return rows;
}

function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

function buildQuiz(data) {
  const quizContainer = document.getElementById("quiz");
  const scoreBox = document.getElementById("scoreBox");
  quizContainer.innerHTML = "";
  scoreBox.innerHTML = "";
  correctCountGlobal = 0;

  const limit = parseInt(document.getElementById("limitInput").value) || data.length;
  const totalQuestions = Math.min(limit, data.length);
  totalQuestionsGlobal = totalQuestions;

  const timeLimit = parseFloat(document.getElementById("timeInput").value);
  if (timeLimit > 0) {
    remainingSeconds = timeLimit * 60;
    quizStartTime = Date.now();
    document.getElementById("timerDisplay").style.display = "block";
    updateTimerDisplay();
    timerInterval = setInterval(() => {
      remainingSeconds--;
      updateTimerDisplay();
      if (remainingSeconds <= 0) endQuiz();
    }, 1000);
  }

  shuffle([...data]).slice(0, totalQuestions).forEach(([question, correct, explanation], i) => {
    const box = document.createElement("div");
    box.className = "question-box";
    box.innerHTML = `<h2>Q${i+1}: ${question}</h2>`;
    
    const input = document.createElement("input");
    input.className = "answer-input";
    input.placeholder = "Nh·∫≠p ƒë√°p √°n c·ªßa b·∫°n...";
    
    const btn = document.createElement("button");
    btn.className = "submit-btn";
    btn.textContent = "Tr·∫£ l·ªùi";
    
    // Allow pressing Enter to submit
    input.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        btn.click(); // trigger button click
      }
    });

    
    const feedback = document.createElement("div");
    feedback.className = "feedback";

    btn.onclick = () => {
      const answer = input.value.trim().toLowerCase();
      const correctAnswer = correct.trim().toLowerCase();

      if (!answer) {
        feedback.textContent = `üëé ƒê·ª´ng b·ªè tr·ªëng, con g√† üêî\nƒê√°p √°n ƒë√∫ng l√† ${correct}\n${explanation}`;
        feedback.style.color = "#ff6600";
        input.style.backgroundColor = "#fff3cd";
        input.style.borderColor = "#ff9800";
        input.disabled = true;
        btn.disabled = true;
      } else if (answer === correctAnswer) {
        feedback.textContent = `‚úÖ Ch√≠nh x√°c!\n${explanation}`;
        feedback.style.color = "green";
        input.style.backgroundColor = "#c8f7c5";
        input.style.borderColor = "#27ae60";
        correctCountGlobal++;
        input.disabled = true;
        btn.disabled = true;
      } else {
        feedback.textContent = `‚ùå Sai r·ªìi!\nƒê√°p √°n ƒë√∫ng: ${correct}\n${explanation}`;
        feedback.style.color = "red";
        input.style.backgroundColor = "#f7c5c5";
        input.style.borderColor = "#e74c3c";
        input.disabled = true;
        btn.disabled = true;
      }

      // üß© Move to next question automatically
      const allQuestions = document.querySelectorAll(".question-box");
      const currentIndex = Array.from(allQuestions).indexOf(box);
      const nextBox = allQuestions[currentIndex + 1];

      if (nextBox) {
        nextBox.scrollIntoView({ behavior: "smooth", block: "start" });
        setTimeout(() => {
          const nextInput = nextBox.querySelector("input.answer-input");
          if (nextInput && !nextInput.disabled) nextInput.focus();
        }, 600);
      }

      // üß† End quiz automatically if last question answered
      if (document.querySelectorAll(".submit-btn:not(:disabled)").length === 0) {
        endQuiz();
        document.getElementById("scoreBox").scrollIntoView({ behavior: "smooth", block: "center" });
      }
    };



    box.appendChild(input);
    box.appendChild(btn);
    box.appendChild(feedback);
    quizContainer.appendChild(box);
  });
}

function updateTimerDisplay() {
  const display = document.getElementById("timerDisplay");
  const mins = Math.floor(remainingSeconds / 60);
  const secs = remainingSeconds % 60;
  display.textContent = `‚è±Ô∏è ${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;
  
  // Flash red in last 10 seconds
  if (remainingSeconds <= 10) {
    display.style.backgroundColor = "#f8d7da";
    display.style.borderColor = "#dc3545";
    display.style.color = "#b30000";
  } else {
    display.style.backgroundColor = "#fff3cd";
    display.style.borderColor = "#ffc107";
    display.style.color = "#d9534f";
  }
}


function endQuiz() {
  clearInterval(timerInterval);
  timerInterval = null;
  quizEnded = true;

  const scoreBox = document.getElementById("scoreBox");
  const timerDisplay = document.getElementById("timerDisplay");
  timerDisplay.style.display = "none";

  const totalTime = ((Date.now() - quizStartTime) / 1000).toFixed(1);
  const percentage = Math.round((correctCountGlobal / totalQuestionsGlobal) * 100);

  // üïí Determine if user ran out of time
  const timeLimitInput = parseFloat(document.getElementById("timeInput").value);
  let timeMessage;
  if (timeLimitInput && remainingSeconds <= 0) {
    timeMessage = "YOU'RE TAKING TOO LONG üéÉ";
  } else {
    timeMessage = `Th·ªùi gian l√†m b√†i: ${totalTime} gi√¢y`;
  }

  // üß† Score feedback
  let resultMessage = "";
  if (percentage >= 75) {
    resultMessage = `Final Score: ${correctCountGlobal}/${totalQuestionsGlobal} (${percentage}%). You‚Äôre a genius! üéâüéâ`;
  } else if (percentage >= 50 && percentage < 75) {
    resultMessage = `Final Score: ${correctCountGlobal}/${totalQuestionsGlobal} (${percentage}%). Congratulations! üéâ`;
  } else if (percentage > 0 && percentage < 50) {
    resultMessage = `Final Score: ${correctCountGlobal}/${totalQuestionsGlobal} (${percentage}%). We Asians are disappointed in you üò°üëø`;
  } else {
    resultMessage = `ARE YOU DUMB?`;
  }

  scoreBox.innerHTML = `${resultMessage}<br>${timeMessage}`;
}


document.getElementById("csvFile").addEventListener("change", e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => {
    lastCSVData = ev.target.result;
	fileNameGlobal = file.name.replace(/\.csv$/i, "").replace(/`/g, '"');
    document.getElementById("importStatus").textContent = `Imported ${file.name} ‚úÖ`;
    document.getElementById("startBtn").style.display = "inline-block";
  };
  reader.readAsText(file);
});

document.getElementById("startBtn").addEventListener("click", () => {
	const mainTitle = document.getElementById("mainTitle");
	mainTitle.textContent = fileNameGlobal || "√îN T·∫¨P FLASHCARD 3 M·∫∂T (T·ª∞ LU·∫¨N)";
	mainTitle.style.textAlign = "center";
	mainTitle.style.marginBottom = "20px";
	mainTitle.style.display = "block";

  if (lastCSVData) {
    document.getElementById("setupSection").style.display = "none";
    buildQuiz(parseCSV(lastCSVData));
    document.getElementById("resetBtn").style.display = "inline-block";
    document.getElementById("replayBtn").style.display = "inline-block";
  }
});

document.getElementById("replayBtn").addEventListener("click", () => {
  if (!lastCSVData) return;

  // üßÆ Create popup form
  const popup = document.createElement("div");
  popup.style.position = "fixed";
  popup.style.top = "50%";
  popup.style.left = "50%";
  popup.style.transform = "translate(-50%, -50%)";
  popup.style.background = "#fff";
  popup.style.padding = "20px 25px";
  popup.style.borderRadius = "10px";
  popup.style.boxShadow = "0 4px 10px rgba(0,0,0,0.3)";
  popup.style.zIndex = "2000";
  popup.style.textAlign = "center";
  popup.style.fontWeight = "bold";
  popup.style.fontSize = "1.05rem";
  popup.innerHTML = `
    <h3>üîÅ Ch∆°i l·∫°i</h3>
    <label for="replayLimit">S·ªë c√¢u h·ªèi:</label><br>
    <input type="number" id="replayLimit" min="1" value="${document.getElementById("limitInput").value || ''}" style="width:80px; margin:5px;"><br>
    <label for="replayTime">Th·ªùi gian l√†m b√†i (ph√∫t):</label><br>
    <input type="number" id="replayTime" min="0.1" step="0.1" value="${document.getElementById("timeInput").value || ''}" style="width:80px; margin:5px;"><br><br>
    <button id="confirmReplay" style="background-color:#007bff; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">B·∫Øt ƒë·∫ßu l·∫°i</button>
    <button id="cancelReplay" style="margin-left:8px; background-color:#dc3545; color:white; border:none; padding:8px 16px; border-radius:6px; cursor:pointer;">H·ªßy</button>
  `;
  document.body.appendChild(popup);

  // Add dim overlay behind the popup
  const overlay = document.createElement("div");
  overlay.id = "replayOverlay";
  overlay.style.position = "fixed";
  overlay.style.top = "0";
  overlay.style.left = "0";
  overlay.style.width = "100%";
  overlay.style.height = "100%";
  overlay.style.backgroundColor = "rgba(0, 0, 0, 0.4)";
  overlay.style.zIndex = "1999";
  document.body.appendChild(overlay);

  document.body.appendChild(popup);


  const replayLimit = document.getElementById("replayLimit");
  const replayTime = document.getElementById("replayTime");
  const confirmBtn = document.getElementById("confirmReplay");
  const cancelBtn = document.getElementById("cancelReplay");

const closePopup = () => {
  document.removeEventListener("keydown", keyHandler);
  if (popup.parentNode) document.body.removeChild(popup);
  const overlayEl = document.getElementById("replayOverlay");
  if (overlayEl && overlayEl.parentNode) document.body.removeChild(overlayEl);
};


  // üß† Handle replay confirmation
  const startReplay = () => {
    const newLimit = parseInt(replayLimit.value);
    const newTime = parseFloat(replayTime.value);

    // update inputs
    if (!isNaN(newLimit)) document.getElementById("limitInput").value = newLimit;
    if (!isNaN(newTime)) document.getElementById("timeInput").value = newTime;

    // cleanup old quiz
    document.getElementById("quiz").innerHTML = "";
    document.getElementById("scoreBox").textContent = "";
    document.getElementById("timerDisplay").style.display = "none";
    clearInterval(timerInterval);
    timerInterval = null;
    quizEnded = false;
    correctCountGlobal = 0;
    totalQuestionsGlobal = 0;

    closePopup();
    buildQuiz(parseCSV(lastCSVData));
  };

  // üß© Keyboard support (Enter & Esc)
  const keyHandler = (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      startReplay();
    } else if (e.key === "Escape") {
      e.preventDefault();
      closePopup();
    }
  };
  document.addEventListener("keydown", keyHandler);

  // üîò Button events
  confirmBtn.onclick = startReplay;
  cancelBtn.onclick = closePopup;
  setTimeout(() => replayLimit.focus(), 100);
});



document.getElementById("resetBtn").addEventListener("click", () => location.reload());
</script>
</body>
</html>
